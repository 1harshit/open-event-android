
<!DOCTYPE html>
<html>
<head>
	<title>Apk Generator</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100' rel='stylesheet' type='text/css'>
	<link href="css/main.css" rel="stylesheet">
</head>
<body>
	<div class="container"><br><br>
		<form class="col-md-offset-4 col-xs-offset-2 col-xs-8 col-md-4 form-group generator_form" method="post" id="form" name="form" role="form"  enctype="multipart/form-data">
			<label for="name">Email</label>
			<input type="email" class="form-control" id="email" name="email">
			<br>
			<input type="hidden" id="theme" name="theme" value="light">

			<label for="name">App's Name</label>
			<input type="text" class="form-control" id="name" name="name">
			<br>
			<label> Choose your data source </label>
			<ul style="list-style-type:none">
				<li><input type="radio" name="datasource" value="jsonupload"> Upload your own JSON files </input></li>
				<li><input type="radio" name="datasource" value="eventapi"> API endpoint of event on OpenEvent </input></li>
			</ul>
			<br>
			<section id="eventapi-input" style="display:none;">
				<label for="apiendpoint">Link to Open Event API endpoint</label>
				<input type="url" class="form-control"
				id="apiendpoint" name="apiendpoint">
			</section>
			<br>
			<section id="jsonupload-input" style="display:none;">
				<input type="file" name="singlefileUpload" id="singlefileUpload" class="form-control"/>
				<br>
			</section>
			<br>
			<input type="hidden" name="assetmode" value="download">
			<center>
				<br>
				<div id="status"></div>
				<br>
				<button type="button" class="download btn btn-default" id="btnGenerate">GENERATE Apk</button>
				<button type="button" class="download btn btn-default" id="btnLive" >PREVIEW</button>
				<button type="button" class="download btn btn-default" id="btnDownload" >DOWNLOAD</button>
				<br>
			</center>

		</form>
		<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
		<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="https://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

		<script>
			$('input:radio[name="datasource"]').change(
  function() {
    if ($(this).is(':checked')) {

      if ($(this).val() === 'mockjson') {
        $('#jsonupload-input').hide(100);
        $('#eventapi-input').hide(100);
      }

      if ($(this).val() === 'jsonupload') {
        $('#jsonupload-input').show(100);
        $('#eventapi-input').hide(100);
      }

      if ($(this).val() === 'eventapi') {
        $('#eventapi-input').show(100);
        $('#jsonupload-input').hide(100);
      }
    }
  });
$('#btnGenerate').click(function () {
  var formData = getData();
  var timestamp = Number(new Date());
  var config = {
    apiKey: "AIzaSyDTo4TPzUkvYYN5dwvNnI4jVmB_eTc0Lpo",
    authDomain: "app-generator.firebaseapp.com",
    databaseURL: "https://app-generator.firebaseio.com",
    storageBucket: "app-generator.appspot.com",
  };
  firebase.initializeApp(config);
  var database = firebase.database();
        var form_data = new FormData();      
        var file_data = $('#singlefileUpload').prop('files')[0];
        form_data.append('file', file_data);                           
        firebase.database().ref('users/' + timestamp).set(formData);
        database.ref('users/' + timestamp).once('value').then(function(snapshot) {
          console.log("Received value",snapshot.val());
          alert("Please wait while we generate the app, meanwhile you can stick around to directly download it.The app will also be emailed to you."); 
          $.ajax({

                  url: '/upload.php', // point to server-side PHP script
                  cache: false,
                  contentType: false,
                  processData: false,
                  data: form_data,                         
                  type: 'post',
                  success: function(php_script_response){
                    ajaxCall1();
                  }
                });
          function ajaxCall1() {
            $.ajax({
              type: "POST",
              url: "/uploadHelper.php",
              data: { timestamp : timestamp },
              success: function(response){
                ajaxCall2();
              }
            });
          }
          function ajaxCall2(){      
            $.ajax({
              type: "POST",
              url: "/runPy.php",
              data: { timestamp : timestamp },
              success: function(response){
                console.log("Success",response);
                window.location = response;
              }
            });
          }
        });
});

function displayButtons (appPath) {
  var btnDownload = $('#btnDownload');
  var btnLive = $('#btnLive');
  btnDownload.css('display', 'block');
  btnLive.css('display', 'block');

  btnLive.click(function () {
    window.location.href = '/live/preview/' + appPath
  });

  btnDownload.click(function () {
    window.location.href = '/download/' + appPath
  })
}

function updateStatus (statusMsg) {
  $('#status').animate({'opacity': 0}, 500, function () {
    $(this).text(statusMsg);
  }).animate({'opacity': 1}, 500);
}

function getData () {
  var data = {};
  var formData = $('#form').serializeArray();
  formData.forEach( function(field) {
    if (field.name == 'name') {data.name = field.value }
    if (field.name == 'email') {data.email = field.value }
    if (field.name == 'theme') {data.theme = field.value }
    if (field.name == 'datasource') {data.datasource = field.value }
    if (field.name == 'apiendpoint') {data.apiendpoint = field.value }
    if (field.name == 'assetmode') {data.assetmode = field.value }});
  try {
    data.singlefileUpload = $('#singlefileUpload')[0].files[0];
    data.zipLength = $('#singlefileUpload')[0].files[0].size;
  } catch (err) {
    data.singlefileUpload = "";
    data.zipLength = 0;
  }
  return data;
}
  </script>
</div>
</body>
</html>

